function footerDetailsPanelEscHandler(e){27===e.keyCode&&toggleFooterDetailsPanel(e)}function toggleFooterDetailsPanel(e){e.preventDefault(),$PBJQ("#Mrphs-footer--details__panel").toggleClass("Mrphs-footer--details__panel-show"),$PBJQ("#Mrphs-footer--details__panel").hasClass("Mrphs-footer--details__panel-show")?($PBJQ(document).on("keyup",footerDetailsPanelEscHandler),$PBJQ("#Mrphs-footer--details__close").focus()):($PBJQ(document).off("keyup",footerDetailsPanelEscHandler),$PBJQ("#Mrphs-footer--details__info").focus())}var selectSiteModalLinks,selectSiteLastModalInTab;!function($){
if(("object"==typeof qtip||"object"==typeof moment||"object"==typeof portal)&&"undefined"!=typeof moment){moment.locale(portal.locale),portal.socialBullhorn=$PBJQ("#Mrphs-social-bullhorn"),portal.academicBullhorn=$PBJQ("#Mrphs-academic-bullhorn");var formatDate=function(instant){return moment.unix(instant.epochSecond).format("L LT")};portal.wrapNoAlertsString=function(noAlertsString){return'<div class="portal-bullhorn-no-alerts">'+noAlertsString+"</div>"},portal.clearBullhornAlert=function(type,id,noAlerts){$PBJQ.get("/direct/portal/clearBullhornAlert",{id:id}).done(function(){
var alertDiv=$PBJQ("#portal-bullhorn-alert-"+id),empty=1===$PBJQ(".portal-bullhorn-"+type+"-alert").length;alertDiv.remove(),empty&&$PBJQ(".portal-bullhorn-"+type+"-alerts").html(portal.wrapNoAlertsString(noAlerts));var count=$PBJQ(".portal-bullhorn-"+type+"-alert").length;portal.setCounter(type,count)})},portal.clearAllAlerts=function(type,noAlerts){$PBJQ.ajax({url:"/direct/portal/clearAll"+type+"Alerts",cache:!1}).done(function(){$PBJQ(".portal-bullhorn-"+type.toLowerCase()+"-alerts").html(portal.wrapNoAlertsString(noAlerts)),portal.setCounter(type.toLowerCase(),0)})},
portal.acceptFriendRequest=function(requestorId,friendId,alertId,noAlertsMessage){confirmFriendRequest(friendId,requestorId),this.clearBullhornAlert(portal.SOCIAL,alertId,noAlertsMessage)},portal.ignoreFriendRequest=function(ignorerId,friendId,alertId,noAlertsMessage){ignoreFriendRequest(friendId,ignorerId),this.clearBullhornAlert(portal.SOCIAL,alertId,noAlertsMessage)},$PBJQ(document).ready(function(){portal.socialBullhorn.qtip({suppress:!1,position:{adjust:{scroll:!1},my:"top right",at:"bottom left",target:portal.socialBullhorn},show:{event:"click",delay:0,solo:portal.academicBullhorn},style:{classes:"portal-bullhorns"},hide:{
event:"click unfocus"},content:{text:function(event,api){return $PBJQ.ajax({url:"/direct/portal/socialAlerts.json",cache:!1}).then(function(data){if(data.message&&"NO_ALERTS"===data.message)return portal.wrapNoAlertsString(data.i18n.noAlerts);var markup='<div class="portal-bullhorn-social-alerts">';return data.alerts.forEach(function(alert){"profile.friend.request"===alert.event?markup+='<a href="javascript:;" class="portal-bullhorn-connectionmanager-pending">':"profile.friend.confirm"===alert.event?markup+='<a href="javascript:;" class="portal-bullhorn-connectionmanager-current">':markup+='<a href="'+alert.url+'">',
markup+='<div id="portal-bullhorn-alert-'+alert.id+'" class="portal-bullhorn-social-alert"><div class="portal-bullhorn-photo" style="background-image:url(/direct/profile/'+alert.from+'/image/thumb)"></div><div class="portal-bullhorn-content"><div class="portal-bullhorn-message"><span class="portal-bullhorn-display-name">'+alert.fromDisplayName+"</span>",
"profile.wall.item.new"===alert.event?markup+=data.i18n.wallPost:"profile.status.update"===alert.event?markup+=data.i18n.statusUpdate:"profile.wall.item.comment.new"===alert.event?markup+=data.i18n.postComment:"profile.friend.request"===alert.event?markup+=data.i18n.friendRequest:"profile.friend.confirm"===alert.event?markup+=data.i18n.friendConfirm:"profile.message.sent"===alert.event?markup+=data.i18n.message:"commons.comment.created"===alert.event?markup+=data.i18n.commentCreated:markup+=data.i18n.unrecognisedAlert;var time=formatDate(alert.eventDate)
;markup+='</div><div class="portal-bullhorn-time">'+time+'</div><div class="portal-bullhorn-options">',"profile.friend.request"===alert.event&&(markup+='<a href="javascript:;" onclick="portal.acceptFriendRequest(\''+alert.from+"','"+alert.to+"','"+alert.id+"','"+data.i18n.noAlerts+"');\">"+data.i18n.accept+"</a>",markup+='<a href="javascript:;" onclick="portal.ignoreFriendRequest(\''+alert.from+"','"+alert.to+"','"+alert.id+"','"+data.i18n.noAlerts+"');\">"+data.i18n.ignore+"</a>"),markup+="</div>",
markup+='</div><div class="portal-bullhorn-clear"><a href="javascript:;" onclick="portal.clearBullhornAlert(\'social\', \''+alert.id+"','"+data.i18n.noAlerts+'\');" title="'+data.i18n.clear+'"><i class="fa fa-times" aria-hidden="true"></i></a></div></div></a>'}),markup+='<div id="portal-bullhorn-clear-all"><a href="javascript:;" onclick="portal.clearAllAlerts(\'Social\',\''+data.i18n.noAlerts+"');\">"+data.i18n.clearAll+"</a></div>",markup+="</div>"},function(xhr,status,error){api.set("content.text",status+": "+error)})}},events:{visible:function(event,api){$PBJQ(".portal-bullhorn-connectionmanager-pending").click(function(e){
portal.connectionManager.show({state:"pending"}),api.hide()}),$PBJQ(".portal-bullhorn-connectionmanager-current").click(function(e){portal.connectionManager.show(),api.hide()})}}}),portal.academicBullhorn.qtip({suppress:!1,position:{adjust:{scroll:!1},my:"top right",at:"bottom left",target:portal.socialBullhorn},show:{event:"click",delay:0,solo:portal.socialBullhorn},style:{classes:"portal-bullhorns"},hide:{event:"click unfocus"},content:{text:function(event,api){return $PBJQ.ajax({url:"/direct/portal/academicAlerts.json",dataType:"json",cache:!1}).then(function(data){
if(data.message&&"NO_ALERTS"===data.message)return portal.wrapNoAlertsString(data.i18n.noAlerts);var markup='<div class="portal-bullhorn-academic-alerts">';return data.alerts.forEach(function(alert){var title=alert.title,siteTitle=alert.siteTitle,faClass="fa-bullhorn";"asn.new.assignment"===alert.event||"asn.grade.submission"===alert.event?faClass="fa-file-text":"lessonbuilder.comment.create"===alert.event&&(faClass="fa-leanpub"),
markup+='<a href="'+alert.url+'" style="text-decoration: none;"><div id="portal-bullhorn-alert-'+alert.id+'" class="portal-bullhorn-academic-alert"><div class="portal-bullhorn-icon fa fa-stack"><i class="fa fa-circle fa-stack-2x"></i><i class="fa '+faClass+' fa-stack-1x fa-inverse"></i></div><div class="portal-bullhorn-content"><div class="portal-bullhorn-message"><span class="portal-bullhorn-display-name">'+alert.fromDisplayName+"</span>";var message=""
;"annc.new"===alert.event||"annc.revise.availability"===alert.event?message=data.i18n.announcement.replace("{0}",title).replace("{1}",siteTitle):"asn.new.assignment"===alert.event?message=data.i18n.assignmentCreated.replace("{0}",title).replace("{1}",siteTitle):"asn.grade.submission"===alert.event?message=data.i18n.assignmentSubmissionGraded.replace("{0}",title).replace("{1}",siteTitle):"commons.comment.created"===alert.event?markup+=data.i18n.academicCommentCreated.replace("{0}",siteTitle):"lessonbuilder.comment.create"===alert.event?markup+=data.i18n.academicLessonBuilderCommentCreate.replace("{0}",siteTitle):markup+=data.i18n.unrecognisedAlert
;var time=formatDate(alert.eventDate);markup+=message+'</div><div class="portal-bullhorn-time">'+time+"</div>",markup+='</div><div class="portal-bullhorn-clear"><a href="javascript:;" onclick="portal.clearBullhornAlert(\'academic\', \''+alert.id+"','"+data.i18n.noAlerts+'\');" title="'+data.i18n.clear+'"><i class="fa fa-times" aria-hidden="true"></i></a></div></div></a>'}),markup+='<div id="portal-bullhorn-clear-all"><a href="javascript:;" onclick="portal.clearAllAlerts(\'Academic\',\''+data.i18n.noAlerts+"');\">"+data.i18n.clearAll+"</a></div>",markup+="</div>"},function(xhr,status,error){api.set("content.text",status+": "+error)})}}})}),
portal.setCounter=function(type,count){var horn=$PBJQ("#Mrphs-"+type+"-bullhorn"),colour="social"===type?"blue":"red";horn.find(".bullhorn-counter").remove(),horn.append('<span class="bullhorn-counter bullhorn-counter-'+colour+'">'+count+"</span>")};var updateCounts=function(){$PBJQ.ajax({url:"/direct/portal/bullhornCounts.json",cache:!1,data:{auto:!0}}).done(function(data){data.academic>0?portal.setCounter("academic",data.academic):portal.academicBullhorn.find(".bullhorn-counter").remove(),data.social>0?portal.setCounter("social",data.social):portal.socialBullhorn.find(".bullhorn-counter").remove()}).fail(function(xhr,status,error){
console&&console.log("Failed to get the bullhorn counts. Status: "+status),console&&console.log("FAILED ERROR: "+error),clearInterval(portal.bullhornCountIntervalId)})};portal.loggedIn&&portal.bullhorns&&portal.bullhorns.enabled&&(updateCounts(),portal.bullhornCountIntervalId=setInterval(updateCounts,portal.bullhorns.pollInterval))}}($PBJQ),$PBJQ("#footerAppPresence").on("click",function(){$PBJQ("#presenceArea").toggleClass("is-hidden")}),function($){if(portal.loggedIn){portal.connectionManager=portal.connectionManager||{}
;var connectionTemplate=Handlebars.templates["connection-manager-connection"],searchResultTemplate=Handlebars.templates["connection-manager-searchresult"],indexedCurrentConnections={},indexedPendingConnections={},countPending=function(){return Object.keys(indexedPendingConnections).length},indexedSearchResults={},lastSearchResults={};$(function(){portal.i18n.loadProperties({resourceClass:"org.sakaiproject.portal.api.PortalService",resourceBundle:"connection-manager",namespace:"connection-manager",callback:function(){portal.i18n.loadProperties({resourceClass:"org.sakaiproject.portal.api.PortalService",resourceBundle:"profile-popup",
namespace:"connection-manager"})}})});var currentTotal=0,currentState="connections",shown=0,pendingTabBaseHtml="";portal.connectionManager.show=function(options){var connectionManager=$("#connection-manager");connectionManager.modal({width:320});var connectionsView=$("#connection-manager-connectionsview"),searchResultsView=$("#connection-manager-searchresultsview"),searchResultsCount=$("#connection-manager-searchresultsview-count"),currentTab=$("#connection-manager-navbar-current > span > a"),pendingTab=$("#connection-manager-navbar-pending > span > a"),updateSearchResultsCount=function(count){
if(0===count)searchResultsCount.html(portal.i18n.tr("connection-manager","connection_manager_no_results"));else{var translateOptions={count:count,criteria:portal.connectionManager.searchCriteria},countMessage=count>1?portal.i18n.tr("connection-manager","connection_manager_results_count",translateOptions):portal.i18n.tr("connection-manager","connection_manager_result_count",translateOptions);searchResultsCount.html(countMessage)}},showCurrentTab=function(){pendingConnectionsWrapper.hide(),currentConnectionsWrapper.show(),connectionsView.show(),searchResultsView.hide(),currentTab.parent().addClass("current"),
pendingTab.parent().removeClass("current")},showPendingTab=function(){currentConnectionsWrapper.hide(),pendingConnectionsWrapper.show(),connectionsView.show(),searchResultsView.hide(),pendingTab.parent().addClass("current"),currentTab.parent().removeClass("current")},addPendingAndShowTab=function(friendId,displayName){var countBefore=countPending();$("#connection-manager-connection-"+friendId).remove(),1===searchResults.children().length&&searchResultsWrapper.hide();var connection=indexedSearchResults[friendId];connection.connected=!1,connection.hideConnect=!0,connection.outgoing=!0,indexedPendingConnections[friendId]=connection
;var markup=connectionTemplate(connection);0===countBefore&&(pendingConnectionsDiv.show().html(""),noPendingConnectionsDiv.hide()),pendingConnectionsDiv.append(markup),updatePendingTabText(),("connections"===currentState||"searchresults"==currentState&&0===moreSearchResults.children().length)&&showPendingTab(),$("#connection-manager-cancel-button-"+friendId).click(cancelHandler)};currentTab.click(function(e){showCurrentTab()}),pendingTab.click(function(e){showPendingTab()})
;var searchResultsWrapper=$("#connection-manager-connectionsview-searchresults-wrapper"),searchResults=$("#connection-manager-connectionsview-searchresults"),moreSearchResults=$("#connection-manager-searchresultsview-results");connectionManager.click(function(e){if("connection-manager-connectionsview-searchbox"!==e.target.id){var wrapperRect=searchResultsWrapper[0].getBoundingClientRect();searchBox[0].getBoundingClientRect();(e.pageX<wrapperRect.left||e.pageY<wrapperRect.top||e.pageX>wrapperRect.left+wrapperRect.width||e.pageY>wrapperRect.top+wrapperRect.height)&&searchResultsWrapper.hide()}})
;var currentConnectionsDiv=$("#connection-manager-current-connections"),currentConnectionsWrapper=$("#connection-manager-current-connections-wrapper"),noCurrentConnectionsDiv=$("#connection-manager-no-current-connections-wrapper"),pendingConnectionsDiv=$("#connection-manager-pending-connections"),pendingConnectionsWrapper=$("#connection-manager-pending-connections-wrapper"),noPendingConnectionsDiv=$("#connection-manager-no-pending-connections-wrapper"),searchBox=$("#connection-manager-connectionsview-searchbox");searchBox.clearSearch({callback:function(){searchResultsWrapper.hide()}})
;var moreSearchBox=$("#connection-manager-searchresultsview-searchbox");0==shown&&(pendingTabBaseHtml=pendingTab.html(),shown+=1);var moveFromPendingToCurrent=function(friendId){$("#connection-manager-connection-"+friendId).remove(),0==currentTotal&&currentConnectionsDiv.html("");var connection=indexedPendingConnections[friendId];connection.outgoing=!1,connection.incoming=!1,connection.connected=!0;var markup=connectionTemplate(connection);currentConnectionsDiv.append(markup),currentTotal+=1,$("#connection-manager-remove-button-"+friendId).click(removeHandler),noCurrentConnectionsDiv.hide(),delete indexedPendingConnections[friendId],
1===searchResults.children().length&&searchResultsWrapper.hide(),indexedCurrentConnections[friendId]=connection,updatePendingTabText(),showCurrentTab()},acceptHandler=function(){var friendId=this.dataset.userId,displayName=this.dataset.displayName;$.ajax("/direct/profile/"+portal.user.id+"/confirmFriendRequest?friendId="+friendId,{cache:!1}).done(function(data){moveFromPendingToCurrent(friendId)}).fail(function(jqXHR,textStatus,errorThrown){console.log("ERROR: failed to confirm request from '"+displayName+"'. errorThrown: "+errorThrown)})},removePending=function(friendId){$(".connection-manager-connection-"+friendId).remove(),
delete indexedPendingConnections[friendId],1===searchResults.children().length&&searchResultsWrapper.hide(),updatePendingTabText()},ignoreHandler=function(){var friendId=this.dataset.userId,displayName=this.dataset.displayName;$.ajax("/direct/profile/"+portal.user.id+"/ignoreFriendRequest?friendId="+friendId,{cache:!1}).done(function(data){removePending(friendId)}).fail(function(jqXHR,textStatus,errorThrown){console.log("ERROR: failed to ignore request from '"+displayName+"'. errorThrown: "+errorThrown)})},connectHandler=function(){var friendId=this.dataset.userId,displayName=this.dataset.displayName
;$.ajax("/direct/profile/"+portal.user.id+"/requestFriend?friendId="+friendId,{cache:!1}).done(function(data){addPendingAndShowTab(friendId)}).fail(function(jqXHR,textStatus,errorThrown){console.log("ERROR: failed to request connection to '"+displayName+"'. errorThrown: "+errorThrown)})},removeCurrent=function(friendId){$("#connection-manager-connection-"+friendId).remove(),0==(currentTotal-=1)&&noCurrentConnectionsDiv.show(),delete indexedCurrentConnections[friendId]},removeHandler=function(){var friendId=this.dataset.userId,displayName=this.dataset.displayName;confirm(portal.i18n.tr("connection-manager","connection_manager_remove_confirm",{
displayName:displayName}))&&$.ajax("/direct/profile/"+portal.user.id+"/removeFriend?friendId="+friendId,{cache:!1}).done(function(data){removeCurrent(friendId)}).fail(function(jqXHR,textStatus,errorThrown){console.log("ERROR: failed to remove '"+displayName+"'. errorThrown: "+errorThrown)})},cancelHandler=function(){var friendId=this.dataset.userId,displayName=this.dataset.displayName;$.ajax("/direct/profile/"+friendId+"/ignoreFriendRequest?friendId="+portal.user.id,{cache:!1}).done(function(data){$(".connection-manager-connection-"+friendId).remove(),delete indexedPendingConnections[friendId],updatePendingTabText()
}).fail(function(jqXHR,textStatus,errorThrown){console.log("ERROR: failed to ignore request from '"+displayName+"'. errorThrown: "+errorThrown)})},updatePendingTabText=function(){var pendingTotal=countPending();0===pendingTotal?(pendingTab.html(pendingTabBaseHtml),pendingConnectionsDiv.html("").hide(),noPendingConnectionsDiv.show()):pendingTab.html(pendingTabBaseHtml+" ("+pendingTotal+")")},search=function(criteria,showFullConnections){$("#connection-manager-profile-popup-container .qtip").remove();var container=showFullConnections?moreSearchResults:searchResults;if(criteria.length<4)return container.html(""),
void(showFullConnections?updateSearchResultsCount(0):searchResultsWrapper.hide());portal.connectionManager.searchCriteria=criteria;var template=showFullConnections?connectionTemplate:searchResultTemplate;$.ajax("/direct/portal/connectionsearch.json?query="+criteria,{cache:!1}).done(function(results){if(container.html(""),0!==results.length){showFullConnections||searchResultsWrapper.show();var markup="";indexedSearchResults={},(lastSearchResults=results).forEach(function(r){indexedSearchResults[r.uuid]=r}),showFullConnections?lastSearchResults.forEach(function(result,i){markup+=template(result)
}):lastSearchResults.slice(0,5).forEach(function(result,i){markup+=template(result)}),showFullConnections&&updateSearchResultsCount(lastSearchResults.length),container.html(markup),container.children().length>0&&container.show(),$(function(){showFullConnections?$(".connection-manager-connect-button").click(connectHandler):profile.attachPopups($(".profile-popup-trigger"),{hide:!0,container:"connection-manager-profile-popup-container",callbacks:{connect:addPendingAndShowTab,cancel:removePending,accept:moveFromPendingToCurrent,ignore:removePending,remove:removeCurrent}}),
$("#connection-manager-connectionsview-searchresults-more").click(function(e){currentState="searchresults",searchResults.html(""),searchResultsWrapper.hide(),connectionsView.hide(),searchResultsView.show(),moreSearchBox.val(portal.connectionManager.searchCriteria),searchBox.val(""),$(function(){updateSearchResultsCount(lastSearchResults.length);var markup="";lastSearchResults.forEach(function(result,i){result.facebookSet=result.socialNetworkingInfo.facebookUrl,result.twitterSet=result.socialNetworkingInfo.twitterUrl,result.moreResult=!0,indexedCurrentConnections.hasOwnProperty(result.uuid)&&(result.connected=!0,result.hideConnect=!0),
indexedPendingConnections.hasOwnProperty(result.uuid)&&(result.connected=!1,result.hideConnect=!0,result.outgoing=indexedPendingConnections[result.uuid].outgoing,result.incoming=indexedPendingConnections[result.uuid].incoming),markup+=connectionTemplate(result)}),moreSearchResults.html(markup),$(function(){$(".connection-manager-accept-button").click(acceptHandler),$(".connection-manager-ignore-button").click(ignoreHandler),$(".connection-manager-connect-button").click(connectHandler),$(".connection-manager-remove-button").click(removeHandler),$(".connection-manager-cancel-button").click(cancelHandler)})})}),
$("#connection-manager-backtoconnections-link").click(function(e){currentState="connections",searchResultsView.hide(),connectionsView.show(),searchResultsWrapper.hide(),searchResults.html(""),searchBox.val("")})})}else showFullConnections||searchResultsWrapper.hide()})};$.ajax("/direct/profile/"+portal.user.id+"/connections.json",{cache:!1}).done(function(data){indexedCurrentConnections={},currentTotal=data.length,searchUserIdFilter=[portal.user.id],currentConnectionsDiv.html(""),0==data.length?noCurrentConnectionsDiv.show():noCurrentConnectionsDiv.hide(),data.forEach(function(connection){
connection.facebookSet=connection.socialNetworkingInfo.facebookUrl,connection.twitterSet=connection.socialNetworkingInfo.twitterUrl,connection.current=!0,connection.connected=!0,connection.incoming=!1,connection.hideConnect=!0,indexedCurrentConnections[connection.uuid]=connection,currentConnectionsDiv.append(connectionTemplate(connection))}),$(function(){$(".connection-manager-remove-button").click(removeHandler)})}).fail(function(jqXHR,textStatus,errorThrown){console.log("ERROR: failed to get current connections. errorThrown: "+errorThrown)});$.ajax("/direct/profile/"+portal.user.id+"/incomingConnectionRequests.json",{cache:!1
}).done(function(data){indexedPendingConnections={},data.forEach(function(connection){connection.incoming=!0}),$.ajax("/direct/profile/"+portal.user.id+"/outgoingConnectionRequests.json",{cache:!1}).done(function(outgoing){var connections;outgoing.forEach(function(connection){connection.outgoing=!0,data.push(connection)}),0==(connections=data).length?(noPendingConnectionsDiv.show(),pendingConnectionsDiv.hide()):(noPendingConnectionsDiv.hide(),pendingConnectionsDiv.show().html("")),connections.forEach(function(connection){connection.hideConnect=!0,connection.pending=!0,pendingConnectionsDiv.append(connectionTemplate(connection)),
indexedPendingConnections[connection.uuid]=connection}),connections.length>0?pendingTab.html(pendingTabBaseHtml+" ("+connections.length+")"):pendingTab.html(pendingTabBaseHtml),$(function(){$(".connection-manager-accept-button").click(acceptHandler),$(".connection-manager-ignore-button").click(ignoreHandler),$(".connection-manager-cancel-button").click(cancelHandler)})}).fail(function(jqXHR,textStatus,errorThrown){console.log("Failed to get outgoing requests. errorThrown: "+errorThrown)})}).fail(function(jqXHR,textStatus,errorThrown){console.log("Failed to get incoming requests. errorThrown: "+errorThrown)}),searchBox.keyup(function(e){
search(this.value,!1)}),searchBox.keydown(function(e){13==e.which&&this.value.length>=4&&$("#connection-manager-connectionsview-searchresults-more").click()}),moreSearchBox.keyup(function(e){search(this.value,!0)}),options&&"pending"===options.state&&showPendingTab()},$("#Mrphs-userNav__submenuitem--connections").click(portal.connectionManager.show)}}($PBJQ),$PBJQ(document).ready(function(){updateFooterTime=function(){
if(1==$PBJQ("#preferredTime").length)var preferredTzDisplay=$PBJQ("#preferredTime").data("preferredtzdisplay"),preferredLocalOffset=new Date(parseInt($PBJQ("#preferredTime").data("preferredserverdateandgmtoffset"))).getTime()-(new Date).getTime();var serverTzDisplay=$PBJQ("#serverTime").data("servertzdisplay"),serverLocalOffset=new Date(parseInt($PBJQ("#serverTime").data("serverdateandgmtoffset"))).getTime()-(new Date).getTime();return function(){var dateString=new Date((new Date).getTime()+serverLocalOffset).toUTCString().replace(/GMT/,serverTzDisplay).replace(/UTC/,serverTzDisplay);if($PBJQ("#serverTime").text(dateString),
1==$PBJQ("#preferredTime").length){dateString=new Date((new Date).getTime()+preferredLocalOffset).toUTCString().replace(/GMT/,preferredTzDisplay).replace(/UTC/,preferredTzDisplay);$PBJQ("#preferredTime").text(dateString)}setTimeout("updateFooterTime()",1e3)}}(),1==$PBJQ("#serverTime").length&&updateFooterTime(),$PBJQ("#Mrphs-footer--details__info").click(function(e){toggleFooterDetailsPanel(e)}),$PBJQ("#Mrphs-footer--details__close").click(function(e){toggleFooterDetailsPanel(e)})}),$PBJQ,portal.loggedIn&&(portal.i18n=portal.i18n||{},portal.i18n.translations=portal.i18n.translations||{},portal.i18n.loadProperties=function(options){
if(options.namespace){var defaults={resourceClass:"org.sakaiproject.i18n.InternationalizedMessages",resourceBundle:"org.sakaiproject.".concat(options.namespace).concat(".bundle.Messages"),namespace:options.namespace};(options=Object.assign(defaults,options)).debug&&(console.log("resourceClass: "+options.resourceClass),console.log("resourceBundle: "+options.resourceBundle),console.log("namespace: "+options.namespace)),portal.i18n.translations[options.namespace]=portal.i18n.translations[options.namespace]||{};var storageKey=portal.locale+options.resourceClass+options.resourceBundle
;null!==sessionStorage.getItem(storageKey)?(options.debug&&console.log("Returning "+storageKey+" from sessions storage ..."),portal.i18n.translations[options.namespace]=JSON.parse(sessionStorage[storageKey]),options.callback&&options.callback()):(options.debug&&console.log(storageKey+" not in sessions storage. Pulling from webservice ..."),$PBJQ.ajax({url:"/sakai-ws/rest/i18n/getI18nProperties"+portal.portalCDNQuery,cache:!0,contentType:"application/json",data:{locale:portal.locale,resourceclass:options.resourceClass,resourcebundle:options.resourceBundle}}).done(function(data,textStatus,jqXHR){data.split("\n").forEach(function(pair){
var keyValue=pair.split("=");2==keyValue.length&&(portal.i18n.translations[options.namespace][keyValue[0]]=keyValue[1]),options.debug&&(console.log("Updated translations: "),console.log(portal.i18n.translations[options.namespace]))}),sessionStorage[storageKey]=JSON.stringify(portal.i18n.translations[options.namespace]),options.callback&&options.callback()}).fail(function(jqXHR,textStatus,errorThrown){console.error(errorThrown)}))}else console.log("You must supply at least a namespace. Doing nothing ...")},portal.i18n.tr=function(namespace,key,options){if(namespace&&key){var ret=portal.i18n.translations[namespace][key]
;if(!ret)return console.log(namespace+"#key "+key+" not found. Returning key ..."),key;if(null!=options)for(var prop in options)ret=ret.replace("{"+prop+"}",options[prop]);return ret}console.log("You must supply a namespace and a key.")},Handlebars.registerHelper("tr",function(namespace,key,options){return new Handlebars.SafeString(portal.i18n.tr(namespace,key,options.hash))})),$PBJQ(document).ready(function(){var _defaults={dragModeStartMsg:"drag start, Use U and D keys to move the item up and down",dragModeEndMsg:"Drag end",newPositionMsg:"Moved to position %s"};$PBJQ.widget("sakai.keyboardSortable",$PBJQ.ui.sortable,{options:{
keyboardHandle:!1},_create:function(){this._super(),this.options.keyboardHandle=this.options.keyboardHandle||this.options.items,this._dragging=!1,this.element.on("keydown",this.options.keyboardHandle,$PBJQ.proxy(this._keydown,this)),this.liveRegion=$PBJQ("<div class='ui-helper-hidden-accessible'></div>").liveregion().appendTo(document.body),this.element.find(this.options.keyboardHandle).attr({"aria-grabbed":"false","data-at-shortcutkeys":'{"u":"drag item up","d":"drag item down"}'}).blur($PBJQ.proxy(function(event){var $target=$PBJQ(event.target);this._isDragging()&&this._toggleDragMode($target,this._closestSortableNode($target))
},this)).click($PBJQ.proxy(function(event){if(event.clientX<=0||void 0===event.clientX){var $target=$PBJQ(event.target);this._toggleDragMode($target,this._closestSortableNode($target))}},this))},_keydown:function(event){if(-1!==$PBJQ.inArray(event.which,[27,38,40,68,85])&&!$PBJQ(event.target).is(":input")){event.preventDefault();var $target=$PBJQ(event.target),$sortableNode=this._closestSortableNode($target);switch(event.which){case 27:this._isDragging()&&this._toggleDragMode($target,$sortableNode);break;case 38:case 85:(event.ctrlKey||this._isDragging()||85===event.which)&&this._moveBackward($sortableNode,$target);break;case 40:case 68:
(event.ctrlKey||this._isDragging()||68===event.which)&&this._moveForward($sortableNode,$target)}}},_closestSortableNode:function($node){var $sortableNode=$node.parentsUntil(this.element).last();return $sortableNode.length||($sortableNode=$node),$sortableNode},_isDragging:function(){return this._dragging},_toggleDragMode:function($node,$sortableNode){var dragging=this._isDragging();$sortableNode.toggleClass("sakai-dragging",!dragging),dragging?($node.attr("aria-grabbed","false"),this._dragging=!1,this._notify(_defaults.dragModeEndMsg)):(this.element.find(this.options.keyboardHandle).attr("aria-grabbed","false"),this._dragging=!0,
$node.attr("aria-grabbed","true"),this._notify(_defaults.dragModeStartMsg))},_moveBackward:function($node,$focused,selector){$prevNode=$node.prev(selector),$prevNode.length&&($prevNode.insertAfter($node),this._highlightDrag($node),this._notifyPosition($node))},_moveForward:function($node,$focused,selector){$nextNode=$node.next(selector),$nextNode.length&&($nextNode.insertBefore($node),this._highlightDrag($node),this._notifyPosition($node))},_highlightDrag:function($node){this._isDragging()||($node.addClass("sakai-dragging-temp"),setTimeout(function(){$node.removeClass("sakai-dragging-temp")},1e3))},_notifyPosition:function($node){
var newIndex=this.element.find(this.options.items).index($node)+1;this._notify(_defaults.newPositionMsg.replace("%s",newIndex))},_notify:function(msg){this.liveRegion.liveregion("instance").notify(msg),this._trigger("update")}}),$PBJQ.widget("sakai.liveregion",{_create:function(){this.timeout=null},notify:function(msg){setTimeout($PBJQ.proxy(function(){var $channel=$PBJQ("<div aria-live='polite'></div>").attr("role","status").appendTo(this.element);this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout($PBJQ.proxy(function(){$channel.text(msg)},this),500),setTimeout($PBJQ.proxy(function(){this._clear($channel)},this),1e4)},this),0)
},_clear:function($node){$node.remove()}})});var dhtml_view_sites=function(){$PBJQ("#selectSiteModal").addClass("dhtml_more_tabs"),$PBJQ(".more-tab").position();var paneHeight=.8*$PBJQ(window).height();dhtml_view_sites=function(){var modal=$PBJQ("#selectSiteModal");if(modal.show(),void 0!==selectSiteModalLinks&&void 0!==selectSiteLastModalInTab||(selectSiteModalLinks=modal.find("button, a"),selectSiteLastModalInTab=modal.find(".tab-box a:last")),modal.on("keydown",function(e){var cancel=!1;if(!(e.ctrlKey||e.metaKey||e.altKey)){switch(e.which){case 27:closeDrawer(),cancel=!0;break;case 9:
e.shiftKey?e.target===selectSiteModalLinks[0]&&(selectSiteModalLinks[selectSiteModalLinks.length-1].focus(),cancel=!0):e.target!==selectSiteModalLinks[selectSiteModalLinks.length-1]&&e.target!==selectSiteLastModalInTab[selectSiteLastModalInTab.length-1]||(selectSiteModalLinks[0].focus(),cancel=!0)}cancel&&e.preventDefault()}}),modal.hasClass("outscreen")){$PBJQ("body").toggleClass("active-more-sites");var topPadding=(allSitesButton=$PBJQ(".view-all-sites-btn:visible")).height()+5;if(allSitesButton.length>0){allSitesButton.css("z-index",1005)
;var topPosition=allSitesButton.offset().top-$PBJQ(window).scrollTop()+topPadding,rightPosition=$PBJQ("body").outerWidth()-(allSitesButton.offset().left+allSitesButton.outerWidth());"rtl"!==$PBJQ("html").attr("dir")?modal.css("top",topPosition).css("right",rightPosition):modal.css("top",topPosition).css("left",$PBJQ("body").outerWidth()-rightPosition)}modal.toggleClass("outscreen"),paneHeight-=topPosition,paneHeight-=parseInt(modal.css("padding-bottom"),20),MorpheusViewportHelper.isNonPhone()&&$PBJQ("#txtSearch").focus(),createDHTMLMask(dhtml_view_sites),$PBJQ(".selectedTab").bind("click",function(e){return dhtml_view_sites(),!1}),
$PBJQ(".tab-pane:first").focus(),$PBJQ(document).trigger("view-sites-shown")}else{var allSitesButton;$PBJQ("body").toggleClass("active-more-sites"),$PBJQ("#selectSiteModal").toggleClass("outscreen"),(allSitesButton=$PBJQ(".view-all-sites-btn")).css("z-index","auto"),$PBJQ("#selectSite").attr("tabindex","-1"),removeDHTMLMask(),$PBJQ("#otherSiteTools").remove(),$PBJQ(".selectedTab").unbind("click")}},$PBJQ(window).width()<800&&(paneHeight*=.85),$PBJQ(".tab-pane").css("height",paneHeight),dhtml_view_sites()};function closeDrawer(){$PBJQ("#selectSiteModal").toggleClass("outscreen"),removeDHTMLMask(),$PBJQ("#selectSite").attr("tabindex","-1"),
$PBJQ("#otherSiteTools").remove(),$PBJQ(".selectedTab").unbind("click"),$PBJQ(".moreSitesLink").unbind("keydown"),$PBJQ(".view-all-sites-btn a:visible").length?$PBJQ(".view-all-sites-btn a").focus():$PBJQ(".js-toggle-sites-nav").focus()}function createDHTMLMask(callback){$PBJQ("body").append('<div id="portalMask">&nbsp;</div>'),$PBJQ("#portalMask").css("height",browserSafeDocHeight()).css({width:"100%","z-index":1e3,top:0,left:0}).attr("tabindex",-1).bind("click",function(event){return callback(),!1}),$PBJQ("#portalMask").bgiframe()}function removeDHTMLMask(){$PBJQ("#portalMask").remove()}function showToolMenu(jqObj){
var classId=jqObj.attr("id"),id=classId.replace(/!/g,"\\!").replace(/~/g,"\\~");if($PBJQ(".toolMenus").removeClass("toolMenusActive").attr("aria-expanded","false"),$PBJQ("."+id).length)$PBJQ("#otherSiteTools").remove();else{var subsubmenu_elt=$PBJQ('<ul id="otherSiteTools" role="menu" />').addClass(classId),siteURL="/direct/site/"+classId+"/pages.json";scroll(0,0);var maxToolsInt=parseInt($PBJQ("#maxToolsInt").text()),maxToolsText=$PBJQ("#maxToolsText").text(),li_template=$PBJQ('<li class="otherSiteTool" ><span><a role="menuitem" tabindex="-1"><span class="Mrphs-toolsNav__menuitem--icon"> </span></a></span></li>'),goToSite=li_template.clone()
;goToSite.addClass("gotosite"),goToSite.find("a").attr("href",portal.portalPath+"/site/"+classId).attr("title",maxToolsText).append(maxToolsText),goToSite.find("a span").addClass("icon-sakai--see-all-tools"),$PBJQ.getJSON(siteURL,function(data){$PBJQ.each(data,function(i,item){if(!item.tools[0])return!0;if(i<maxToolsInt){var li=li_template.clone();li.find("a").attr("href",item.tools[0].url).attr("title",item.title).append(item.title),li.find("a span").addClass("icon-sakai--"+item.tools[0].toolId.replace(/\./gi,"-")).addClass("otherSiteToolIcon"),
item.toolpopup&&li.find("a").attr("href",item.tools[0].url+"?sakai.popup=yes").attr("onclick","window.open("+item.toolpopupurl+"); return false"),subsubmenu_elt.append(li)}}),data.length>maxToolsInt&&subsubmenu_elt.append(goToSite.clone()),$PBJQ("#otherSiteTools").remove(),jqObj.closest("li").append(subsubmenu_elt),jqObj.closest("li").find("ul li a").first().focus(),addArrowNavAndDisableTabNav($PBJQ("ul#otherSiteTools")),jqObj.parent().find(".toolMenus").addClass("toolMenusActive").attr("aria-expanded","true")})}}$PBJQ(document).ready(function(){1===$PBJQ("#eid").length&&$PBJQ("#eid").focus(),
$PBJQ(".js-toggle-sites-nav","#skipNav").on("click",dhtml_view_sites),$PBJQ("#show-all-sites, .view-all-sites-btn").on("click",dhtml_view_sites);var siteTitle=portal.siteTitle;function resetSearch(){$PBJQ("#txtSearch").val(""),$PBJQ(".fav-sites-term, .fav-sites-entry").show(),$PBJQ("#noSearchResults").hide(),$PBJQ("#txtSearch").focus()}siteTitle&&(portal.shortDescription&&(siteTitle=siteTitle+" ("+portal.shortDescription+")"),$PBJQ(".portletTitle h2").prepend('<span class="siteTitle">'+siteTitle+":</span> ")),$PBJQ("#txtSearch").keyup(function(event){if(27==event.keyCode&&resetSearch(),$PBJQ("#txtSearch").val().length>0){
var queryString=$PBJQ("#txtSearch").val().toLowerCase();$PBJQ(".fav-sites-term, .fav-sites-entry").hide();var matched_sites=$PBJQ(".fav-sites-entry").filter(function(idx,entry){return $PBJQ(".fav-title a span.fullTitle",entry).text().toLowerCase().indexOf(queryString)>=0});matched_sites.show(),matched_sites.closest(".fav-sites-term").show()}0==$PBJQ("#txtSearch").val().length&&resetSearch(),$PBJQ("#otherSiteList li:visible").length<1&&$PBJQ(".otherSitesCategorList li:visible").length<1&&($PBJQ(".norecords").remove(),$PBJQ("#noSearchResults").fadeIn("slow"))}),$PBJQ("#otherSiteSearchClear").on("click",function(){resetSearch()}),
$PBJQ("#presenceToggle").click(function(e){e.preventDefault(),$PBJQ("#presenceArea").toggle()}),$PBJQ(".trayPopupClose").click(function(e){e.preventDefault(),$PBJQ(this).closest(".trayPopup").hide()}),$PBJQ("a.tool-directurl").length&&$PBJQ("a.tool-directurl").cluetip({local:!0,arrows:!0,cluetipClass:"jtip",sticky:!0,cursor:"pointer",activation:"click",closePosition:"title",closeText:'<img src="/library/image/silk/cross.png" alt="close">'})}),$PBJQ(document).ready(function($){
var autoFavoritesEnabled=!0,initialFavoritesList=void 0,favoritesList=[],maxFavoriteEntries=$PBJQ("#max-favorite-entries").text().trim(),favoritesLoaded=!1,container=$PBJQ("#selectSite"),favoritesPane=$PBJQ("#otherSitesCategorWrap"),organizePane=$PBJQ("#organizeFavorites"),itemsBySiteId={};$PBJQ(".site-favorite-btn",favoritesPane).each(function(i,e){itemsBySiteId[$PBJQ(e).attr("data-site-id")]=$PBJQ(e).parent()});var button_states={favorite:{markup:'<i class="site-favorite-icon site-favorite"></i>'},nonfavorite:{markup:'<i class="site-favorite-icon site-nonfavorite"></i>'},myworkspace:{
markup:'<i class="site-favorite-icon site-workspace site-favorite"></i>'}},setButton=function(btn,state){var entry=button_states[state];$PBJQ(btn).data("favorite-state",state),"favorite"===state?$PBJQ(btn).attr("title",$PBJQ("#removeFromFavoritesText").text().replace("[site]",$PBJQ(btn).parent().find("span.fullTitle").text())):"nonfavorite"===state?$PBJQ(btn).attr("title",$PBJQ("#addToFavoritesText").text().replace("[site]",$PBJQ(btn).parent().find("span.fullTitle").text())):$PBJQ(btn).attr("title",null),$PBJQ(btn).empty().append($PBJQ(entry.markup))},renderFavoriteCount=function(){
var favoriteCount=$PBJQ(".fav-sites-entry .site-favorite",favoritesPane).length;$PBJQ(".favoriteCount",container).text("("+favoriteCount+")"),favoriteCount>maxFavoriteEntries?$PBJQ(".favoriteCountAndWarning").addClass("maxFavoritesReached"):$PBJQ(".favoriteCountAndWarning").removeClass("maxFavoritesReached")},setAllOrNoneStarStates=function(){$PBJQ(".favorites-select-all-none",favoritesPane).each(function(idx,selectAllNone){var termContainer=$PBJQ(selectAllNone).closest(".fav-sites-term"),siteCount=termContainer.find(".fav-sites-entry:not(.my-workspace)").length,favoritedSiteCount=termContainer.find(".fav-sites-entry .site-favorite").length
;0==siteCount?$PBJQ(selectAllNone).hide():(favoritedSiteCount==siteCount?($PBJQ(selectAllNone).data("favorite-state","favorite"),$PBJQ(selectAllNone).html(button_states.favorite.markup)):($PBJQ(selectAllNone).data("favorite-state","nonfavorite"),$PBJQ(selectAllNone).html(button_states.nonfavorite.markup)),$PBJQ(selectAllNone).show())})},renderFavorites=function(favorites){$PBJQ(".site-favorite-btn",favoritesPane).each(function(idx,btn){var buttonSiteId=$PBJQ(btn).attr("data-site-id")
;$PBJQ(btn).closest(".my-workspace").length>0?setButton(btn,"myworkspace"):$PBJQ.inArray(buttonSiteId,favorites)>=0?setButton(btn,"favorite"):setButton(btn,"nonfavorite")}),$PBJQ(".favorites-help-text").hide(),autoFavoritesEnabled?$PBJQ(".favorites-help-text.autofavorite-enabled").show():$PBJQ(".favorites-help-text.autofavorite-disabled").show(),setAllOrNoneStarStates(),renderFavoriteCount(),favoritesLoaded=!0},loadFromServer=function(attempt){var callback;syncInProgress&&(favoritesLoaded=!1,$PBJQ(".site-favorite-btn",favoritesPane).empty(),$PBJQ(".favorites-select-all-none",favoritesPane).empty()),attempt||(attempt=0),
syncInProgress&&attempt<100?setTimeout(function(){loadFromServer(attempt+1)},50):(callback=renderFavorites,$PBJQ.ajax({url:"/portal/favorites/list",method:"GET",dataType:"json",success:function(data){autoFavoritesEnabled=data.autoFavoritesEnabled,favoritesList=data.favoriteSiteIds.filter(function(e,i){return""!=e}),null==initialFavoritesList&&(initialFavoritesList=favoritesList),callback(favoritesList)}}))},syncInProgress=!1,nextToSync=[],runNextServerUpdate=function(onError){for(var newState;nextToSync.length>0;)newState=nextToSync.shift();newState?$PBJQ.ajax({url:"/portal/favorites/update",method:"POST",dataType:"json",data:{
userFavorites:JSON.stringify(newState)},error:onError,complete:runNextServerUpdate}):syncInProgress=!1},syncWithServer=function(onError){if(favoritesLoaded){onError||(onError=function(){});var newFavorites=$PBJQ(".site-favorite-btn",favoritesPane).has(".site-favorite").map(function(){return $PBJQ(this).attr("data-site-id")}).toArray(),newState={favoriteSiteIds:newFavorites=newFavorites.sort(function(a,b){return-1===favoritesList.indexOf(a)?1:-1===favoritesList.indexOf(b)?-1:favoritesList.indexOf(a)-favoritesList.indexOf(b)}),autoFavoritesEnabled:autoFavoritesEnabled};nextToSync.push(newState),syncInProgress||(syncInProgress=!0,
runNextServerUpdate(onError)),favoritesList=newFavorites,function(){if(function(a1,a2){if(a1.length!=a2.length)return!1;for(var i=0;i<a1.length;i++)if(a1[i]!=a2[i])return!1;return!0}(favoritesList,initialFavoritesList))$PBJQ(".moresites-refresh-notification").remove();else if(!($PBJQ(".moresites-refresh-notification").length>0)){var notification=$PBJQ('<div class="moresites-refresh-notification" />').html($PBJQ("#refreshNotificationText").html());$PBJQ("#loginLinks").prepend(notification),notification.css("top",$PBJQ(".Mrphs-siteHierarchy").offset().top+"px")}}()}},returnElementToOriginalPositionIfPossible=function(siteId){
if(initialFavoritesList&&initialFavoritesList.indexOf(siteId)>-1){for(var idx=initialFavoritesList.indexOf(siteId),placed=!1,neighborIdx=idx-1;neighborIdx>=0;neighborIdx--){var neighbor=initialFavoritesList[neighborIdx],neighborCurrentIndex=favoritesList.indexOf(neighbor);if(neighborCurrentIndex>=0&&neighborCurrentIndex<idx){favoritesList.splice(neighborCurrentIndex+1,0,siteId),placed=!0;break}}placed||favoritesList.splice(idx,0,siteId)}};$PBJQ(favoritesPane).on("click",".site-favorite-btn",function(){var newState,siteId=$PBJQ(this).attr("data-site-id"),originalState=$PBJQ(this).data("favorite-state")
;"myworkspace"!==originalState&&("favorite"==(newState="favorite"===originalState?"nonfavorite":"favorite")&&returnElementToOriginalPositionIfPossible(siteId),setButton(this,newState),setAllOrNoneStarStates(),renderFavoriteCount(),syncWithServer(function(){loadFromServer()}))}),$PBJQ(favoritesPane).on("click",".favorites-select-all-none",function(){var newState,state=$PBJQ(this).data("favorite-state"),buttons=$PBJQ(this).closest(".fav-sites-term").find(".fav-sites-entry:not(.my-workspace) .site-favorite-btn");newState="favorite"==state?"nonfavorite":"favorite",buttons.each(function(idx,button){setButton($PBJQ(button),newState)}),
renderFavoriteCount(),setAllOrNoneStarStates(),syncWithServer(function(){loadFromServer()})}),$PBJQ(container).on("click",".tab-btn",function(){$PBJQ(".tab-btn",container).removeClass("active").attr("aria-selected","false").attr("tabindex","-1"),$PBJQ(this).addClass("active").attr("aria-selected","true").attr("tabindex","0");var panel=$PBJQ(this).data("tab-target");$PBJQ(".tab-box").hide(),$PBJQ(container).trigger("tab-shown",panel),$PBJQ("#"+panel).show()}),$PBJQ(container).on("keydown",".tab-btn",function(e){32==e.keyCode&&($PBJQ(this).click(),e.preventDefault()),37==e.keyCode&&($PBJQ("[aria-selected=true]").prev().click().focus(),
e.preventDefault()),38==e.keyCode&&($PBJQ("[aria-selected=true]").prev().click().focus(),e.preventDefault()),39==e.keyCode&&($PBJQ("[aria-selected=true]").next().click().focus(),e.preventDefault()),40==e.keyCode&&($PBJQ("[aria-selected=true]").next().click().focus(),e.preventDefault())}),$PBJQ(document).on("view-sites-shown",function(){loadFromServer()}),$PBJQ(container).on("tab-shown",function(e,panelId){if("organizeFavorites"===panelId){var list=$PBJQ("#organizeFavoritesList");list.empty(),$PBJQ("#noFavoritesToShow").hide(),$PBJQ("#favoritesToShow").hide(),$PBJQ("#otherSiteTools").remove(),$PBJQ("#organizeFavoritesPurgatoryList").empty(),
$PBJQ.each(favoritesList,function(idx,siteid){if(itemsBySiteId[siteid]&&!$PBJQ(itemsBySiteId[siteid]).hasClass("my-workspace")){var favoriteItem=itemsBySiteId[siteid].clone(!1);favoriteItem.addClass("organize-favorite-item").data("site-id",siteid);var dragHandle=$PBJQ('<a href="javascript:void(0);" class="fav-drag-handle"><i class="fa fa-bars"></i></a>');$PBJQ(".toolMenus",favoriteItem).remove(),favoriteItem.append(dragHandle),list.append(favoriteItem),favoriteItem.show()}}),0==list.find("li").length?$PBJQ("#noFavoritesToShow").show():$PBJQ("#favoritesToShow").show();var highlightMaxItems=function(){var items=$PBJQ(".organize-favorite-item")
;items.removeClass("site-favorite-is-past-max"),$PBJQ(".favorites-max-marker").remove(),$PBJQ.each(items,function(idx,li){idx>=maxFavoriteEntries&&$PBJQ(li).addClass("site-favorite-is-past-max"),idx==maxFavoriteEntries&&$PBJQ(li).before($PBJQ('<li class="favorites-max-marker"><i class="fa fa-warning warning-icon"></i> '+$PBJQ("#maxFavoritesLimitReachedText").text()+"</li>"))})};highlightMaxItems(),list.keyboardSortable({items:"li:not(.favorites-max-marker)",handle:".fav-drag-handle",update:function(){highlightMaxItems(),favoritesList=list.find(".organize-favorite-item *[data-site-id]").map(function(){return $PBJQ(this).attr("data-site-id")
}).toArray(),syncWithServer()}}),list.disableSelection(),$PBJQ("#autoFavoritesEnabled").attr("aria-checked",autoFavoritesEnabled),$PBJQ("#organizeFavorites .onoffswitch").show()}}),$PBJQ(favoritesPane).on("click",".toolMenus",function(e){return e.preventDefault(),showToolMenu($PBJQ(this)),!1}),$PBJQ(organizePane).on("click",".site-favorite-btn",function(){if(!($PBJQ(this).closest(".my-workspace").length>0)){var buttonState,li=$PBJQ(this).parent();if(0==$PBJQ(this).closest("#organizeFavoritesList").length){var siteId=$PBJQ(this).attr("data-site-id");returnElementToOriginalPositionIfPossible(siteId);var newIndex=favoritesList.indexOf(siteId)
;0==newIndex?$PBJQ("#organizeFavoritesList").prepend(li):newIndex>0?$PBJQ("#organizeFavoritesList li:nth-child("+newIndex+")").after(li):$PBJQ("#organizeFavoritesList").append(li),buttonState="favorite"}else $PBJQ("#organizeFavoritesPurgatoryList").append(li),buttonState="nonfavorite";setButton(this,buttonState),setButton(itemsBySiteId[$PBJQ(this).attr("data-site-id")].find(".site-favorite-btn"),buttonState),setAllOrNoneStarStates(),renderFavoriteCount(),syncWithServer(function(){loadFromServer()})}}),$PBJQ("#autoFavoritesEnabled").click(function(){$PBJQ(this).attr("aria-checked",function(index,clicked){return String(!("true"===clicked))}),
$PBJQ(this).trigger("change")}),$PBJQ("#autoFavoritesEnabled").on("change",function(){return autoFavoritesEnabled="true"===$PBJQ(this).attr("aria-checked"),$PBJQ(".favorites-help-text").hide(),autoFavoritesEnabled?$PBJQ(".favorites-help-text.autofavorite-enabled").show():$PBJQ(".favorites-help-text.autofavorite-disabled").show(),syncWithServer(),!0}),$PBJQ(".otherSitesMenuClose").on("click",function(){dhtml_view_sites()})});var profile=profile||{};function publishSite(siteId){var reqUrl="/direct/site/"+siteId+"/edit";$PBJQ.ajax({type:"POST",data:"published=true",url:reqUrl,success:function(){location.reload()}}).responseText}
function quickLinksNavEscHandler(e){27===e.keyCode&&toggleQuickLinksNav(e)}function toggleQuickLinksNav(event){if(event.preventDefault(),$PBJQ(".Mrphs-userNav__subnav").hasClass("is-hidden")||toggleUserNav(event),$PBJQ(".Mrphs-quickLinksNav__subnav").toggleClass("is-hidden"),$PBJQ(".Mrphs-quickLinksNav__subnav").hasClass("is-hidden"))$PBJQ(".quicklinks-dropdown-overlay").remove(),$PBJQ("body").css("overflow-y","visible"),$PBJQ(document).off("keyup",quickLinksNavEscHandler);else{var overlay=$PBJQ('<div class="quicklinks-dropdown-overlay" />');overlay.on("click",function(e){toggleQuickLinksNav(e)}),$PBJQ("body").prepend(overlay),
$PBJQ("body").css("overflow-y","hidden"),$PBJQ(document).on("keyup",quickLinksNavEscHandler),$PBJQ(".tab-box").css("max-height",window.innerHeight-$PBJQ("#selectQuickLink").offset().top-14)}}!function($){profile.requestFriend=function(requestorId,friendId,callback){return new Promise((resolve,reject)=>{$.ajax({url:"/direct/profile/"+requestorId+"/requestFriend?friendId="+friendId,dataType:"text",cache:!1}).done(function(data,textStatus,jqXHR){$("#profile-popup-request-button-"+friendId).hide(),$("#profile-popup-cancel-button-"+friendId).show(),callback&&callback(friendId),resolve(!0)}).fail((jqXHR,textStatus,errorThrown)=>reject())})},
profile.confirmFriendRequest=function(requestorId,friendId,callback){return new Promise((resolve,reject)=>{$.ajax({url:"/direct/profile/"+requestorId+"/confirmFriendRequest?friendId="+friendId,dataType:"text",cache:!1}).done(function(data,textStatus,jqXHR){$("#profile-popup-incoming-block-"+friendId).hide(),$("#profile-popup-remove-button-"+friendId).show(),callback&&callback(friendId),resolve(!0)}).fail((jqXHR,textStatus,errorThrown)=>reject())})},profile.removeFriend=function(removerId,friendId,callback,displayName){return new Promise((resolve,reject)=>{$.ajax({url:"/direct/profile/"+removerId+"/removeFriend?friendId="+friendId,
dataType:"text",cache:!1}).done(function(data,textStatus,jqXHR){$("#profile-popup-remove-button-"+friendId).hide(),$("#profile-popup-request-button-"+friendId).show(),callback&&callback(friendId),resolve(!0)}).fail((jqXHR,textStatus,errorThrown)=>reject())})},profile.ignoreFriendRequest=function(removerId,friendId,cancel,callback){return new Promise((resolve,reject)=>{$.ajax({url:"/direct/profile/"+removerId+"/ignoreFriendRequest?friendId="+friendId,cache:!1}).done(function(data,textStatus,jqXHR){void 0!==cancel&&1==cancel?($("#profile-popup-cancel-button-"+removerId).hide(),$("#profile-popup-request-button-"+removerId).show(),
callback&&callback(removerId)):($("#profile-popup-incoming-block-"+friendId).hide(),$("#profile-popup-request-button-"+friendId).show(),callback&&callback(friendId)),resolve(!0)}).fail((jqXHR,textStatus,errorThrown)=>reject())})},profile.attachPopups=function(jqArray,options){if(jqArray instanceof $){options||(options={});var hide=options.hide,callbacks=options.callbacks;callbacks||(callbacks={}),jqArray.each(function(){var userId=this.dataset.userId,targets=(this.dataset.displayName,$(this).find(".profile-popup-target")),position={target:targets.length>0?targets.eq(0):$(this),my:"top left",at:"bottom center",viewport:$(window),adjust:{
method:"flipinvert none"}};options&&options.container&&(position.container=$(`#${options.container}`)),$(this).qtip({position:position,show:{event:"click",delay:0},style:{classes:"profile-popup-qtip qtip-shadow"},hide:{event:"click unfocus"},content:{text:function(event,api){return $.ajax({url:"/direct/portal/"+userId+"/formatted",cache:!1}).then(function(html){return html},function(xhr,status,error){api.set("content.text",status+": "+error)})}},events:{visible:function(event,api){$("#profile-popup-request-button-"+userId).off("click").on("click",e=>{profile.requestFriend(portal.user.id,userId,callbacks.connect).then(()=>{hide&&api.hide()})
}),$("#profile-popup-cancel-button-"+userId).off("click").on("click",e=>{profile.ignoreFriendRequest(userId,portal.user.id,!0,callbacks.cancel).then(()=>{hide&&api.hide()})}),$("#profile-popup-accept-button-"+userId).off("click").on("click",e=>{profile.confirmFriendRequest(portal.user.id,userId,callbacks.accept).then(()=>{hide&&api.hide()})}),$("#profile-popup-ignore-button-"+userId).off("click").on("click",e=>{profile.ignoreFriendRequest(portal.user.id,userId,!1,callbacks.ignore).then(()=>{hide&&api.hide()})}),$("#profile-popup-remove-button-"+userId).off("click").on("click",e=>{
profile.removeFriend(portal.user.id,userId,callbacks.remove).then(()=>{hide&&api.hide()})})}}})})}else console.log("profile.attachPopups takes a jQuery object array, from a selector")}}($PBJQ),$PBJQ("#quickLinks-close").on("click",toggleQuickLinksNav),$PBJQ(".js-toggle-quick-links-nav").on("click",toggleQuickLinksNav),$PBJQ(document).ready(function(){return $PBJQ("#reorder-list li").size()-1>15&&($PBJQ(".grabHandle").show(),$PBJQ("#inputFieldMessage").show(),$PBJQ("#inputKbdMessage").remove()),$PBJQ("#reorder-list li").each(function(n){$PBJQ("#lastMoveArrayInit").append($PBJQ(this).attr("id")+" "),
$PBJQ("#lastMoveArray").append($PBJQ(this).attr("id")+" ")}),$PBJQ('input[id^="index"]').click(function(event){event.stopPropagation()}),$PBJQ('input[id^="index"]').bind("keypress",function(e){return 13!=(e.charCode||e.keyCode)}),$PBJQ("#undo-all").click(function(event){var initOrder;for(z in initOrder=$PBJQ.trim($PBJQ("#lastMoveArrayInit").text()).split(" "))thisRow=document.getElementById(initOrder[z]),$PBJQ(thisRow).appendTo("#reorder-list");event.preventDefault(),registerChange(),$PBJQ("#undo-all").hide(),$PBJQ("#undo-all-inact").show(),$PBJQ("#undo-last-inact").show(),$PBJQ("#undo-last").hide()}),
$PBJQ("#undo-last").click(function(event){var prevOrder,lastMovedT,lastMoved;for(z in prevOrder=$PBJQ.trim($PBJQ("#lastMoveArray").text()).split(" "))thisRow=document.getElementById(prevOrder[z]),$PBJQ(thisRow).appendTo("#reorder-list");lastMovedT=$PBJQ.trim($PBJQ("#lastItemMoved").text()),lastMoved=$PBJQ("li:eq("+lastMovedT.substr(20)+")"),$PBJQ(lastMoved).addClass("recentMove"),event.preventDefault(),registerChange("notfluid",lastMoved),$PBJQ("#undo-last-inact").fadeIn("slow"),$PBJQ("#undo-last").hide()}),$PBJQ('input[id^="index"]').change(function(){var that=this;preserveStatus()
;var oldVal=parseInt($PBJQ(this).siblings('input[id^="holder"]').attr("value")),newVal=parseInt(this.value);if(isNaN(newVal)||newVal>$PBJQ('input[id^="index"]').size()){var failedValidMessage=$PBJQ("#failedValidMessage").text();$PBJQ("#messageHolder").text(failedValidMessage.replace("#",$PBJQ('input[id^="index"]').size())),$PBJQ(".orderable-selected").removeClass("orderable-selected"),$PBJQ("#messageHolder").removeClass("messageSuccess"),$PBJQ("#messageHolder").addClass("messageValidation");var messagePos=$PBJQ(that).position();return $PBJQ("#messageHolder").css({position:"absolute",height:"1.3em",top:messagePos.top,left:55}),
$PBJQ("#messageHolder").fadeIn("slow"),$PBJQ("#messageHolder").animate({opacity:1},2e3,function(){$PBJQ(that).val(oldVal),that.focus(),that.select()}),$PBJQ("#messageHolder").fadeOut("slow"),$PBJQ(this).parents("li").addClass("orderable-selected"),null}var inputs=$PBJQ('input[id^="index"]');$PBJQ("#undo-last").fadeIn("slow"),$PBJQ("#undo-last-inact").hide(),$PBJQ("#undo-all").fadeIn("slow"),$PBJQ("#undo-all-inact").hide(),
"1"===newVal?$PBJQ($PBJQ(this).parents("li")).insertBefore($PBJQ(this).parents("li").siblings("li").children("span").children("input[value="+newVal+"]").parents("li")):newVal==inputs.length?$PBJQ($PBJQ(this).parents("li")).insertAfter($PBJQ(this).parents("li").siblings("li").children("span").children("input[value="+newVal+"]").parents("li")):newVal>oldVal?$PBJQ($PBJQ(this).parents("li")).insertAfter($PBJQ(this).parents("li").siblings("li").children("span").children("input[value="+newVal+"]").parents("li")):$PBJQ($PBJQ(this).parents("li")).insertBefore($PBJQ(this).parents("li").siblings("li").children("span").children("input[value="+newVal+"]").parents("li")),
registerChange("notfluid",$PBJQ(this).parents("li"))}),$PBJQ("#reorder-list").keyboardSortable({items:"li:not(.notsortable)",start:function(event,ui){preserveStatus(ui)},update:function(event,ui){registerChange(event,ui)}})});var registerChange=function(originEvent,movedEl){$PBJQ("#reorder-list li").size();"notfluid"!==originEvent&&(movedEl=$PBJQ("li[aria-selected='true']")),$PBJQ("#lastItemMoved").text($PBJQ(movedEl).attr("id")),$PBJQ(movedEl).addClass("recentMove");$PBJQ(movedEl.prevAll("li").length+1)
;for(var inputsX=$PBJQ('input[id^="index"]'),holderinputs=$PBJQ('input[id^="holder"]'),selectItems=$PBJQ("select.selectSet"),i=0;i<inputsX.length;i+=1)$PBJQ(inputsX[i]).attr("value",i+1).val(i+1);for(var x=0;x<holderinputs.length;x+=1)$PBJQ(holderinputs[x]).attr("value",x+1).val(x+1);for(var y=0;y<selectItems.length;y+=1)$PBJQ(selectItems[y]).val(y+1),$PBJQ(selectItems[y]).find("option").removeAttr("selected"),$PBJQ(selectItems[y]).find("option[value="+(y+1)+"]").attr("selected","selected");$PBJQ("#undo-last").fadeIn("slow"),$PBJQ("#undo-last-inact").hide(),$PBJQ("#undo-all").fadeIn("slow"),$PBJQ("#undo-all-inact").hide(),
$PBJQ(movedEl).animate({opacity:1},2e3,function(){$PBJQ(movedEl).removeClass("recentMove")})},preserveStatus=function(item){$PBJQ("#lastMoveArray").text(""),$PBJQ("#reorder-list li").each(function(n){void 0!==$PBJQ(this).attr("id")&&"undefined_avatar"!==$PBJQ(this).attr("id")&&$PBJQ("#lastMoveArray").append($PBJQ(this).attr("id")+" ")})};function toggleToolsNav(event){event&&event.preventDefault(),$PBJQ("body").toggleClass("toolsNav--displayed"),$PBJQ("body").hasClass("toolsNav--displayed")?createDHTMLMask(toggleToolsNav):removeDHTMLMask()}$PBJQ(document).ready(function(){$PBJQ("#roleSwitchSelect").on("change",function(){
""!==$PBJQ("option:selected",this).text()?document.location=$PBJQ("option:selected",this).val()+"#roleSwitch":$PBJQ(this)[0].selectedIndex=0}),MorpheusViewportHelper.isPhone()?function(){function closeTheRoleSwitchToggle(){$PBJQ("#roleSwitchDropDown").is(".open")&&$PBJQ("#roleSwitchDropDownToggle").trigger("click")}function handleKeyUp(event){return 27!=event.keyCode||(closeTheRoleSwitchToggle(),!1)}$PBJQ("#roleSwitchDropDownToggle").attr("aria-hidden","false").attr("aria-haspopup","true"),$PBJQ("#roleSwitchDropDown").attr("aria-hidden","true"),$PBJQ("#roleSwitchDropDownToggle").click(function(){
$PBJQ("#roleSwitchDropDown").css("right",$PBJQ(window).width()-20-($PBJQ("#roleSwitchDropDownToggle").offset().left+$PBJQ("#roleSwitchDropDownToggle").width())),$PBJQ("#roleSwitchDropDown").toggleClass("open"),$PBJQ("#roleSwitchDropDown").is(".open")?($PBJQ("#roleSwitchDropDown").attr("aria-hidden","false"),$PBJQ(document.body).prepend('<div class="user-dropdown-overlay"></div>'),$PBJQ(".user-dropdown-overlay").on("click",function(){closeTheRoleSwitchToggle()}),$PBJQ(document.body).on("keyup",handleKeyUp),setTimeout(function(){$PBJQ("#roleSwitchDropDown").find("a, :input").focus()})):($PBJQ("#roleSwitchDropDown").attr("aria-hidden","true"),
$PBJQ(".user-dropdown-overlay").remove(),$PBJQ(document.body).off("keyup",handleKeyUp),$PBJQ("#roleSwitchDropDownToggle").focus())})}():$PBJQ("#roleSwitch").addClass("menu-not-setup")}),$PBJQ(".js-toggle-tools-nav","#skipNav").on("click",toggleToolsNav);var sessionTimeOut,timeoutDialogWarningTime,timeoutLoggedoutUrl,timeoutPortalPath,sessionId="current",timeoutDialogEnabled=!1;$PBJQ(document).ready(function(){portal.loggedIn&&portal.timeoutDialog&&setTimeout("setup_timeout_config();",6e4)});var setup_timeout_config=function(){timeoutDialogEnabled=portal.timeoutDialog.enabled,timeoutDialogWarningTime=portal.timeoutDialog.seconds,
timeoutLoggedoutUrl=portal.loggedOutUrl,timeoutPortalPath=portal.portalPath,1==timeoutDialogEnabled&&(poll_session_data(),fetch_timeout_dialog())},poll_session_data=function(){$PBJQ.ajax({url:"/direct/session/"+sessionId+".json?auto=true&_="+(new Date).getTime(),dataType:"json",success:function(data){if(data.maxInactiveInterval=1e3*data.maxInactiveInterval,data.active&&null!=data.userId&&data.lastAccessedTime+data.maxInactiveInterval>data.currentTime){var remaining=data.lastAccessedTime+data.maxInactiveInterval-data.currentTime;remaining<1e3*timeoutDialogWarningTime?(min=Math.round(remaining/6e4),show_timeout_alert(min),
clearTimeout(sessionTimeOut),sessionTimeOut=setTimeout("poll_session_data()",6e4)):(clearTimeout(sessionTimeOut),sessionTimeOut=setTimeout("poll_session_data()",remaining-1e3*timeoutDialogWarningTime))}else null==data.userId?location.href=timeoutLoggedoutUrl:sessionTimeOut=setTimeout("poll_session_data()",1e4)},error:function(XMLHttpRequest,status,error){}})};function keep_session_alive(){dismiss_session_alert(),$PBJQ.get(timeoutPortalPath)}var timeoutDialogFragment,dismiss_session_alert=function(){removeDHTMLMask(),$PBJQ("#timeout_alert_body").remove()};function fetch_timeout_dialog(){$PBJQ.ajax({url:"/portal/timeout?auto=true",cache:!0,
dataType:"text",success:function(data){timeoutDialogFragment=data},error:function(XMLHttpRequest,status,error){timeoutDialogEnabled=!1}})}function show_timeout_alert(min){if(timeoutDialogEnabled)if($PBJQ("#portalMask").get(0)||(createDHTMLMask(dismiss_session_alert),$PBJQ("#portalMask").css("z-index",1e3)),$PBJQ("#timeout_alert_body").get(0))$PBJQ("#timeout_alert_body span").html(min);else{var dialog=timeoutDialogFragment.replace("{0}",min);$PBJQ("body").append(dialog)}}function toggleShortUrlOutput(defaultUrl,checkbox,textbox){$PBJQ(checkbox).is(":checked")?$PBJQ.ajax({url:"/direct/url/shorten?path="+encodeURI(defaultUrl),dataType:"text",
success:function(shortUrl){$PBJQ("."+textbox).val(shortUrl)}}):$PBJQ("."+textbox).val(defaultUrl)}$PBJQ(document).ready(function(){$PBJQ(".Mrphs-toolTitleNav__link--directurl").click(function(e){var origin=$PBJQ(this).position(),$dialog=$PBJQ(this).siblings(".Mrphs-directUrl");$dialog.toggleClass("active").css({left:origin.left+"px"}),$dialog.attr("aria-expanded","true"),$dialog.find("[tabindex]").first().focus(),e.preventDefault()}),$modal_container=$PBJQ(".Mrphs-directUrl"),$modal_container.each(function(index){var $invokerTabs=$PBJQ(this).find("[tabindex]");$invokerTabs.first().on("keydown",function(e){
if(9===e.keyCode&&e.shiftKey)return $invokerTabs.last().focus(),e.preventDefault(),!1}),$invokerTabs.last().on("keydown",function(e){if(9===e.keyCode&&!e.shiftKey)return $invokerTabs.first().focus(),e.preventDefault(),!1})}),$modal_container.last().on("keypress",function(e){if(9===e.keyCode())return console.log("keypress:: primero"),$modal_container.fist().focus(),e.preventDefault(),!1}),$PBJQ(".Mrphs-directUrl .dropDown_close").on("click keypress",function(e){var $dialog=$PBJQ(this).parent();$dialog.toggleClass("active"),$dialog.removeAttr("aria-expanded"),$PBJQ('.Mrphs-toolTitleNav__link--directurl[rel="#'+$dialog.attr("id")+'"]').focus(),
e.preventDefault()})});var setupSkipNav=function(){$PBJQ("#skipNav a.Mrphs-skipNav__link").click(function(){var target=$PBJQ(this).attr("href");$PBJQ(target).attr("tabindex","-1").focus()})};$PBJQ(document).ready(function(){var lastScrollTop=0;$PBJQ(document).scroll(function(event){var st=$PBJQ(this).scrollTop();st>lastScrollTop&&st>90?($PBJQ(".Mrphs-topHeader").addClass("moving"),$PBJQ(".Mrphs-siteHierarchy").addClass("moving"),$PBJQ(".Mrphs-toolsNav__title--current-site").addClass("moving"),$PBJQ(".Mrphs-skipNav__menu").addClass("moving"),
$PBJQ(".Mrphs-sitesNav__menuitem--myworkspace").addClass("moving")):(st>90||0==st)&&($PBJQ(".Mrphs-topHeader").removeClass("moving"),$PBJQ(".Mrphs-siteHierarchy").removeClass("moving"),$PBJQ(".Mrphs-toolsNav__title--current-site").removeClass("moving"),$PBJQ(".Mrphs-skipNav__menu").removeClass("moving"),$PBJQ(".Mrphs-sitesNav__menuitem--myworkspace").removeClass("moving")),lastScrollTop=st})});var closeAllDropdownMenus=function(){$PBJQ(".Mrphs-sitesNav__menuitem").removeClass("dropdown-is-visible"),$PBJQ(".Mrphs-sitesNav__menuitem").find(".is-visible").removeClass("is-visible"),
$PBJQ(".Mrphs-sitesNav__menuitem").find(".is-clicked").removeClass("is-clicked"),$PBJQ(".sitenav-dropdown-overlay").remove()},buildDropdownMenu=function(container,siteId,callback){
var navsubmenu='<ul class="Mrphs-sitesNav__submenu" role="menu">',maxToolsInt=parseInt($PBJQ("#linkNav").attr("data-max-tools-int")),maxToolsText=$PBJQ("#linkNav").attr("data-max-tools-anchor"),goToSite='<li class="Mrphs-sitesNav__submenuitem Mrphs-sitesNav__submenuitem__gotosite"><a tabindex="-1" role="menuitem" href="'+portal.portalPath+"/site/"+siteId+'" title="'+maxToolsText+'"><span class="toolMenuIcon icon-sakai--see-all-tools"></span>'+maxToolsText+"</a></li>",siteURL="/direct/site/"+siteId+"/pages.json",currentSite=window.location.pathname.split("/").pop();$PBJQ.ajax({url:siteURL,dataType:"json",success:function(data){
$PBJQ.each(data,function(i,item){if(item.tools&&!(item.tools.length<=0)){var isCurrent="";if(currentSite==item.tools[0].id&&(isCurrent=" is-current"),i<=maxToolsInt){var li_template
;if(item.toolpopup)li_template='<li class="Mrphs-sitesNav__submenuitem" ><a tabindex="-1" class="Mrphs-sitesNav__submenuitem-link"'+' role="menuitem" href="{{tool_url}}?sakai.popup=yes" title="{{item_title}}" onclick="window.open(\'{{item_toolpopupurl}}\');"'+'>  <span class="Mrphs-sitesNav__submenuitem-icon"><span class="toolMenuIcon icon-sakai--{{icon}}"></span></span>  <span class="Mrphs-sitesNav__submenuitem-title">{{item_title}}</span></a></li>';else li_template='<li class="Mrphs-sitesNav__submenuitem{{is_current}}"><a tabindex="-1" class="Mrphs-sitesNav__submenuitem-link"'+' role="menuitem" href="{{tool_url}}" title="{{item_title}}"'+'>  <span class="Mrphs-sitesNav__submenuitem-icon"><span class="toolMenuIcon icon-sakai--{{icon}}"></span></span>  <span class="Mrphs-sitesNav__submenuitem-title">{{item_title}}</span></a></li>'
;navsubmenu+=li_template.replace(/{{tool_url}}/g,item.tools[0].url).replace(/{{item_title}}/g,item.title).replace(/{{item_toolpopupurl}}/g,item.toolpopupurl).replace(/{{icon}}/g,item.tools[0].toolId.replace(/\./gi,"-")).replace(/{{is_current}}/g,isCurrent)}}}),data.length-1>maxToolsInt&&(navsubmenu+=goToSite),navsubmenu+="</ul>",navsubmenu=$PBJQ(navsubmenu),container.append(navsubmenu),addArrowNavAndDisableTabNav(navsubmenu),callback(navsubmenu)},error:function(XMLHttpRequest,status,error){}})},setupSiteNav=function(){$PBJQ("ul.Mrphs-sitesNav__menu").each(function(){$PBJQ(this).keydown(function(e){27==e.keyCode&&closeAllDropdownMenus()})}),
$PBJQ(document).on("keydown",".Mrphs-sitesNav__menu > li.Mrphs-sitesNav__menuitem > a",function(e){if(40==e.keyCode){e.preventDefault();var dropdown=$PBJQ(this).parent().find(".Mrphs-sitesNav__dropdown");dropdown.data("clicked")||(dropdown.data("clicked",!0),dropdown.trigger("click"))}else 27==e.keyCode&&(e.preventDefault(),closeAllDropdownMenus())}),$PBJQ("ul.Mrphs-sitesNav__menu li .Mrphs-sitesNav__dropdown").click(function(e){e.preventDefault();var jqObjDrop=$PBJQ(e.target),container=jqObjDrop.parent(".Mrphs-sitesNav__menuitem"),dropdownWasShown=container.hasClass("dropdown-is-visible");if(closeAllDropdownMenus(),!dropdownWasShown){
var dropdownArrow=$PBJQ(this),displayDropdown=function(navsubmenu){dropdownArrow.addClass("is-clicked"),container.addClass("dropdown-is-visible"),navsubmenu.addClass("is-visible"),container.find("li a").first().focus();var overlay=$PBJQ('<div class="sitenav-dropdown-overlay" />');overlay.on("click",function(e){closeAllDropdownMenus()}),$PBJQ("body").prepend(overlay),dropdownArrow.removeData("clicked")};container.find("ul").length?displayDropdown(container.find("ul")):buildDropdownMenu(container,jqObjDrop.attr("data-site-id"),displayDropdown)}}).hover(function(){$PBJQ(this).toggleClass("Mrphs-sitesNav__dropdown--hover")})}
;function addArrowNavAndDisableTabNav(ul){ul.find("li a").attr("tabindex","-1").keydown(function(e){var obj=$PBJQ(e.target);if(40==e.keyCode){e.preventDefault();var next=obj.closest("li").next();0!==next.length&&0!=next.find("a").length||(next=ul.find("li").first()),ul.find("li a").attr("tabindex","-1"),next.find("a").focus().attr("tabindex","0")}else if(38==e.keyCode){e.preventDefault();var prev=obj.closest("li").prev();0===prev.length&&(prev=ul.find("a").closest("ul")),ul.find("li a").attr("tabindex","-1"),prev.find("a").focus().attr("tabindex","0")}else 9==e.keyCode&&closeAllDropdownMenus()})}function updatePresence(){$PBJQ.ajax({
url:sakaiPresenceFragment,cache:!1,success:function(frag){var $presenceIframe=$PBJQ("#presenceIframe");$presenceIframe.html(frag);var $presenceCount=$PBJQ("#presenceCount");if($presenceIframe.is(":empty"))return $presenceCount.html(" "),$presenceCount.removeClass("present").addClass("empty"),void location.reload();var userCount=$presenceIframe.find(".listUser").length;userCount>1?($presenceCount.html(userCount+""),$presenceCount.removeClass("empty").addClass("present")):1==userCount?($PBJQ("#presenceCount").html(userCount+""),$presenceCount.removeClass("present").addClass("empty")):($PBJQ("#presenceCount").html(" "),
$presenceCount.removeClass("present").addClass("empty"));var chatUrl=$PBJQ(".nav-selected .icon-sakai-chat").attr("href");$PBJQ("#presenceIframe .presenceList div.inChat span").wrap('<a href="'+chatUrl+'"></a>'),sakaiLastPresenceTimeOut=setTimeout("updatePresence()",3e4)},error:function(request,strError){sakaiLastPresenceTimeOut=setTimeout("updatePresence()",6e4)}})}function userNavEscHandler(e){27===e.keyCode&&toggleUserNav(e)}function toggleUserNav(event){if(event.preventDefault(),$PBJQ(".Mrphs-userNav__subnav").toggleClass("is-hidden"),$PBJQ(".Mrphs-userNav__subnav").hasClass("is-hidden"))$PBJQ(".user-dropdown-overlay").remove(),
$PBJQ(document).off("keyup",userNavEscHandler);else{var overlay=$PBJQ('<div class="user-dropdown-overlay" />');overlay.on("click",function(e){toggleUserNav(e)}),$PBJQ("body").prepend(overlay),$PBJQ(document).on("keyup",userNavEscHandler)}}portal=portal||{},void 0===portal.toolsCollapsed&&(portal.toolsCollapsed=!1),portal.updateToolsCollapsedPref=function(collapsed){if(portal.user.id){var url="/direct/userPrefs/updateKey/"+portal.user.id+"/sakai:portal:sitenav?toolsCollapsed="+collapsed;$PBJQ.ajax(url,{method:"PUT",cache:!1})}},portal.toggleMinimizeNav=function(){$PBJQ("body").toggleClass("Mrphs-toolMenu-collapsed"),
$PBJQ("#subSites.floating").css({display:"none"});var el=$PBJQ(this);el.toggleClass("min max").parent().toggleClass("min max"),portal.toolsCollapsed?(portal.updateToolsCollapsedPref(!1),portal.toolsCollapsed=!1,el.attr("aria-pressed",!1)):(portal.updateToolsCollapsedPref(!0),portal.toolsCollapsed=!0,el.attr("aria-pressed",!0))},$PBJQ("#toolsNav-toggle-li button").on("click",portal.toggleMinimizeNav),$PBJQ(document).ready(function(){$PBJQ("#toggleSubsitesLink").click(function(e){var subsitesLink=$PBJQ(this);if("block"==$PBJQ("#subSites").css("display"))$PBJQ("#subSites").hide(),$PBJQ("#subSites").removeClass("floating");else{
var position=subsitesLink.position(),_top=-1*($PBJQ("#toolMenu").height()-position.top),subsitesPosition=MorpheusViewportHelper.isPhone()?{display:"block",top:0,overflow:"hidden"}:{display:"block",left:$PBJQ("#toolMenu").width()+7+"px",top:_top+"px"};$PBJQ("#subSites").css(subsitesPosition),$PBJQ("#subSites").addClass("floating"),$PBJQ("#subSites").find("li a").first().focus(),$PBJQ("#toggleSubsitesLink").position().top<240&&$PBJQ("#subSites.floating").addClass("ontop")}})}),$PBJQ("#loginLink1").click(function(e){""===$PBJQ(this).attr("data-warning")||confirm($PBJQ(this).attr("data-warning"))||e.preventDefault()}),
$PBJQ(".js-toggle-user-nav a#loginUser > .Mrphs-userNav__drop-btn","#loginLinks").on("click",toggleUserNav),$PBJQ(".js-toggle-user-nav .Mrphs-userNav__drop-btn","#loginLinks").on("click",toggleUserNav),$PBJQ(".Mrphs-userNav__pic-changer").on("click",function(event){var $profileLink=$PBJQ(this);if(!window.FileReader)return $PBJQ($profileLink.data("profileLink")).trigger("click"),!0;if(!$PBJQ.fn.modal)return $PBJQ($profileLink.data("profileLink")).trigger("click"),!0;function setCropWidgetURL(url){var $toolbar;$cropWidget.show(),$cropWidget.find("> img").cropper("clear"),$cropWidget.find("> img").cropper("replace",url),
$save.removeProp("disabled"),$toolbar=$PBJQ("#cropToolbar").show(),portal.pictureToolbarSetup||($PBJQ(".profile-image-zoom-in",$toolbar).on("click",function(){$cropWidget.find("> img").cropper("zoom",.1)}),$PBJQ(".profile-image-zoom-out",$toolbar).on("click",function(){$cropWidget.find("> img").cropper("zoom",-.1)}),$PBJQ(".profile-image-pan-up",$toolbar).on("click",function(){$cropWidget.find("> img").cropper("move",0,-10)}),$PBJQ(".profile-image-pan-down",$toolbar).on("click",function(){$cropWidget.find("> img").cropper("move",0,10)}),$PBJQ(".profile-image-pan-left",$toolbar).on("click",function(){
$cropWidget.find("> img").cropper("move",10,0)}),$PBJQ(".profile-image-pan-right",$toolbar).on("click",function(){$cropWidget.find("> img").cropper("move",-10,0)}),$PBJQ(".profile-image-rotate",$toolbar).on("click",function(){$cropWidget.find("> img").cropper("clear"),$cropWidget.find("> img").cropper("rotate",90),$cropWidget.find("> img").cropper("crop")}),portal.pictureToolbarSetup=!0)}function loadExistingProfileImage(){$PBJQ.getJSON("/direct/profile-image/details?_="+(new Date).getTime(),function(json){"SUCCESS"==json.status&&(json.isDefault||(setCropWidgetURL(json.url+"?_="+(new Date).getTime()),
$PBJQ(".remove-profile-image").on("click",function(){$modal.find(".modal-body .alert").hide(),$PBJQ.ajax("/direct/profile-image/remove",{data:{sakai_csrf_token:sakai_csrf_token},type:"POST",dataType:"json",success:function(data,textStatus,jqXHR){"SUCCESS"==data.status?(refreshProfileImageTagsAndHideDialog(),$PBJQ("#cropToolbar").hide()):$PBJQ("#remove-error").show()}})}))),sakai_csrf_token=json.csrf_token})}function refreshProfileImageTagsAndHideDialog(){var picLink=$PBJQ("#loginUser > .Mrphs-userNav__submenuitem--profilepicture"),parent=picLink.parent();picLink.detach()
;var d=new Date,style="background-image: url(/direct/profile/"+portal.user.id+"/image/thumb?"+d.getTime()+")";picLink.attr("style",style),parent.prepend(picLink),parent=(picLink=$PBJQ(".Mrphs-userNav__submenuitem--profilelink > .Mrphs-userNav__submenuitem--profilepicture")).parent(),picLink.detach(),picLink.attr("style",style),parent.prepend(picLink),$PBJQ("#profileImageUpload").modal("hide")}event.preventDefault(),event.stopImmediatePropagation();var $modal=$PBJQ("#profileImageUpload");$modal.on("shown.bs.modal",function(){loadExistingProfileImage()}),$modal.modal({width:320}),$PBJQ("#remove-error").hide(),$PBJQ("#upload-error").hide()
;var $save=$modal.find("#save"),$fileUpload=$PBJQ("#file"),$cropWidget=$PBJQ("#cropme").hide();return $cropWidget.find("> img").cropper({aspectRatio:1,checkCrossOrigin:!1,guides:!0,minContainerWidth:300,minContainerHeight:300,autoCropArea:1,viewMode:1,dragMode:"move"}),$fileUpload.on("change",function(){$PBJQ(this);if(!this.files||!this.files[0])throw"Browser does not support FileReader";var reader=new FileReader;reader.onload=function(e){setCropWidgetURL(e.target.result)},reader.readAsDataURL(this.files[0])}),$save.on("click",function(ev){new Promise(function(resolve){resolve($cropWidget.find("> img").cropper("getCroppedCanvas",{width:200,
height:200}).toDataURL())}).then(function(src){var imageByteSrc;imageByteSrc=src.replace(/^data:image\/(png|jpg);base64,/,""),$modal.find(".modal-body .alert").hide(),$PBJQ.ajax("/direct/profile-image/upload",{data:{sakai_csrf_token:sakai_csrf_token,base64:imageByteSrc},type:"POST",dataType:"json",success:function(data,textStatus,jqXHR){"SUCCESS"==data.status?refreshProfileImageTagsAndHideDialog():$PBJQ("#upload-error").show()}})})}),!1});var header=$PBJQ(".Mrphs-topHeader"),currentHeaderWidth=-1;function f_scrollTop(){
return f_filterResults(window.pageYOffset?window.pageYOffset:0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)}function f_filterResults(n_win,n_docel,n_body){var n_result=n_win||0;return n_docel&&(!n_result||n_result>n_docel)&&(n_result=n_docel),n_body&&(!n_result||n_result>n_body)?n_body:n_result}$PBJQ(document).ready(function(){$PBJQ(header).data("sticked",!1),
$PBJQ(".Mrphs-hierarchy--parent-sites").length>0&&$PBJQ(window).width()<=800&&$PBJQ("#content").css("margin-top",parseInt($PBJQ("#content").css("margin-top").replace("px",""))+$PBJQ(".Mrphs-hierarchy--parent-sites").outerHeight(!0)+"px"),$PBJQ(window).resize(function(){currentHeaderWidth=$PBJQ(".Mrphs-mainHeader").width()}),$PBJQ(window).scroll(function(){var stick=$PBJQ(document).height()-$PBJQ(window).height()>$PBJQ(header).height()==!0;$PBJQ(window).scrollTop()>0?!1===$PBJQ(header).data("sticked")&&!0===stick&&($PBJQ(header).data("sticked",!0),
$PBJQ(".Mrphs-mainHeader").addClass("is-fixed")):($PBJQ(".Mrphs-mainHeader").removeClass("is-fixed"),$PBJQ(header).data("sticked",!1))}),currentHeaderWidth=$PBJQ(".Mrphs-mainHeader").width(),$PBJQ(".Mrphs-headerLogo").on("click",function(){document.body.scrollTop=0,document.body.scrollLeft=0,$PBJQ(window).trigger("scroll")})}),$PBJQ(document).ready(function(){$PBJQ("input, textarea","#content").each(function(){$PBJQ(this).prop("disabled")&&$PBJQ(this).parent("label").addClass("disabled")}),$PBJQ(document).keyup(function(e){
27==e.keyCode&&($PBJQ("#selectSiteModal").hasClass("outscreen")||$PBJQ("#otherSitesMenu .otherSitesMenuClose").trigger("click"),$PBJQ(".Mrphs-directUrl__dropDown").each(function(){$PBJQ(this).hasClass("active")&&$PBJQ(this).find(".dropDown_close").trigger("click")}),$PBJQ(".fip-icon-up-dir").trigger("click"),$PBJQ(".navigatePanelControls .close").trigger("click"))})});var MorpheusViewportHelper={isPhone:function(){return $PBJQ("#Mrphs-viewport-helpers .phone").is(":visible")},isTablet:function(){return $PBJQ("#Mrphs-viewport-helpers .tablet").is(":visible")},isDesktop:function(){return $PBJQ("#Mrphs-viewport-helpers .desktop").is(":visible")
},isNonPhone:function(){return(this.isDesktop()||this.isTablet())&&!this.isPhone()}};$PBJQ(document).ready(function(){1==$PBJQ("#loginLink2").length&&$PBJQ("#loginLink2").click(function(e){$PBJQ("body").append('<div id="Mrphs-xlogin-container" />'),$PBJQ("#Mrphs-xlogin-container").load("/portal/xlogin #Mrphs-xlogin",function(){$PBJQ("#Mrphs-xlogin-container").addClass("loaded"),$PBJQ("#Mrphs-xlogin").addClass("loadedByAjax"),$PBJQ("#eid").focus()}),$PBJQ(".Mrphs-portalWrapper").addClass("blurry"),$PBJQ("body").append('<div id="loginPortalMask" />'),$PBJQ("#loginPortalMask").bgiframe(),$PBJQ("#loginPortalMask").click(function(){
$PBJQ("#loginPortalMask").remove(),$PBJQ("#Mrphs-xlogin-container").remove(),$PBJQ(".Mrphs-portalWrapper").removeClass("blurry")}),e.preventDefault()})}),function($){console.log("duke-default/_customization.js loaded"),$(".Mrphs-toolTitleNav__link--directurl").on("click",function(e){var label=$(this).siblings(".Mrphs-toolTitleNav__link--help-popup")[0].search,gaEventData={hitType:"event",eventCategory:"toolTitleNav",eventAction:"showDirectLink",eventLabel:document.title+" : "+label.substring(6,label.length)};ga("send",gaEventData)}),$(".Mrphs-toolTitleNav__link--help-popup").on("click",function(e){var label=$(this)[0].search,gaEventData={
hitType:"event",eventCategory:"toolTitleNav",eventAction:"goToHelp",eventLabel:document.title+" : "+label.substring(6,label.length)};ga("send",gaEventData)}),$("#print-view").on("click",function(e){var label=$(this)[0].search,gaEventData={hitType:"event",eventCategory:"toolTitleNav",eventAction:"lessionsPrintView",eventLabel:document.title+" : "+label.substring(6,label.length)};ga("send",gaEventData)}),$("#print-all").on("click",function(e){var label=$(this)[0].search,gaEventData={hitType:"event",eventCategory:"toolTitleNav",eventAction:"lessionsPrintAll",eventLabel:document.title+" : "+label.substring(6,label.length)};ga("send",gaEventData)
}),$("#show-pages").on("click",function(e){var label=$(this)[0].search,gaEventData={hitType:"event",eventCategory:"toolTitleNav",eventAction:"lessionsIndexOfPages",eventLabel:document.title+" : "+label.substring(6,label.length)};ga("send",gaEventData)}),$(".Mrphs-sitesNav__dropdown").on("click",function(e){var label=$(this).siblings("a.link-container")[0].title,gaEventData={hitType:"event",eventCategory:"sitesNav",eventAction:"openToolDropdown",eventLabel:document.title+" : "+label};ga("send",gaEventData)}),$(".Mrphs-hierarchy--toolName").on("click",function(e){var gaEventData={hitType:"event",eventCategory:"hierarchy",
eventAction:"refreshTool",eventLabel:document.title};ga("send",gaEventData)}),$(".view-all-sites-btn").on("click",function(e){var gaEventData={hitType:"event",eventCategory:"topHeader",eventAction:"openAllSitesDropdown",eventLabel:document.title};ga("send",gaEventData)}),$("#toolsNav-toggle-li").on("click",function(e){var toggleState="undefined";$(this).hasClass("min")?toggleState="collapseTools":$(this).hasClass("max")&&(toggleState="maximizeTools");var gaEventData={hitType:"event",eventCategory:"toolMenu",eventAction:toggleState,eventLabel:document.title};ga("send",gaEventData)}),$("#print-view").on("click",function(e){var gaEventData={
hitType:"event",eventCategory:"toolTitleNav",eventAction:"showLessonsPrintView",eventLabel:document.title};ga("send",gaEventData)}),$("#show-pages").on("click",function(e){var gaEventData={hitType:"event",eventCategory:"toolTitleNav",eventAction:"showLessonsPages",eventLabel:document.title};ga("send",gaEventData)});!function(){var bodyClasses=[],serverClass=new URL(window.location.href).hostname.replace(/\./g,"-");bodyClasses.push(`duke-${serverClass}`);var userSiteRole=`duke-role-${portal.user.siteRole.toLowerCase()}`;bodyClasses.push(userSiteRole),
$("#loginLink1").find(".Mrphs-login-Message").text().startsWith("Return")&&bodyClasses.push("duke-become-user"),document.getElementsByTagName("body")[0].classList.add(...bodyClasses)}();var targetNode,collapseToolsAdjustedTop=0,watchForPasystemChange=function(){var pasystemNode=document.getElementsByClassName("pasystem-banner-alerts")[0],pasystemToggleNode=document.getElementsByClassName("pasystem-banner-alert-toggle")[0],config={childList:!0,attributes:!0,subtree:!0,attributeOldValue:!0},pasystemMutationCallback=function(mutationsList,pasystemObserver){
for(var mutation of mutationsList)"childList"==mutation.type&&(collapseToolsAdjustedTop=pasystemNode.clientHeight,$("#toolsNav-toggle-li").css({top:collapseToolsAdjustedTop})),"attributes"==mutation.type&&mutation.target.className.includes("pasystem-banner-alert")&&(collapseToolsAdjustedTop=pasystemNode.clientHeight,$("#toolsNav-toggle-li").css({top:collapseToolsAdjustedTop}))},pasystemObserver=new MutationObserver(pasystemMutationCallback),pasystemToggleObserver=new MutationObserver(pasystemMutationCallback);pasystemObserver.observe(pasystemNode,config),pasystemToggleObserver.observe(pasystemToggleNode,config)}
;if(targetNode=document.getElementsByClassName("Mrphs-portalBody")[0],new MutationObserver(function(mutationsList,portalObserver){for(var mutation of mutationsList)"childList"==mutation.type&&"pasystem-banner-alerts"==mutation.target.childNodes[0].className&&(collapseToolsAdjustedTop=document.getElementsByClassName("pasystem-banner-alerts")[0].clientHeight,$("#toolsNav-toggle-li").css({top:collapseToolsAdjustedTop}),watchForPasystemChange(),portalObserver.disconnect())}).observe(targetNode,{childList:!0}),$(window).scroll(function(){$(window).scrollTop()>0?$("#toolsNav-toggle-li").css({top:0}):$("#toolsNav-toggle-li").css({
top:collapseToolsAdjustedTop})}),"Sakai : Home : Overview"===document.title){window.setTimeout(function(){let motdCards=document.getElementsByClassName("Mrphs-toolBody--sakai-motd")[0].getElementsByTagName("iframe")[0].contentWindow.document.getElementsByClassName("textPanel"),motdArr=[].slice.call(motdCards),tallestMOTD=Math.max.apply(Math,motdArr.map(function(card){return card.clientHeight}));for(let i=0;i<motdArr.length;i++)motdCards[i].style.height=`${tallestMOTD}px`,void 0!==motdCards[i].getElementsByTagName("a")[0]&&(motdCards[i].getElementsByTagName("a")[0].style.cssText="bottom: 16px")},1e3)}
if((document.querySelector('#msgForum .itemNav .button[title=" < Previous Topic"]')||document.querySelector('#msgForum .itemNav .button[title=" Next Topic >"]'))&&document.getElementsByClassName("topicBloc topicBlocLone specialLink")&&window.innerWidth>1030){let forumDescHeight=49+document.getElementsByClassName("topicBloc topicBlocLone specialLink")[0].clientHeight;document.querySelector("#msgForum .itemNav").style.cssText=`top:${forumDescHeight}px`}if("null"!==document.getElementById("footer-links")){let buildTimeHtml="<dt>Skin Version:</dt><dd>Wed, 26 Feb 2020 14:36:50 EST</dd>"
;document.querySelector("#Mrphs-footer--details__panel dl").insertAdjacentHTML("beforeend",buildTimeHtml)}}($PBJQ),$PBJQ,console.log("duke-pratt/_customization.js loaded");
